name: Mutation Testing

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  mutants:
    name: Mutation Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-mutants
        run: cargo install cargo-mutants --version 26.1.2 --locked

      - name: Get changed Rust files
        id: changed
        run: |
          set -euo pipefail
          git fetch origin "${{ github.base_ref }}":"refs/remotes/origin/${{ github.base_ref }}" || true

          git diff --name-only "origin/${{ github.base_ref }}...HEAD" -- '*.rs' \
            | grep -v '/tests/' \
            | grep -v '_test\.rs$' \
            | grep -v '^fuzz/' \
            | grep -v '/fuzz/' \
            | head -20 \
            > changed_files.txt || true

          COUNT="$(wc -l < changed_files.txt | tr -d ' ')"
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          cat changed_files.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Run mutation tests on changed files
        if: steps.changed.outputs.count != '0'
        env:
          CI: true
        run: |
          set -euo pipefail
          echo "Running mutation testing on ${{ steps.changed.outputs.count }} changed file(s)..."

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            [ -f "$file" ] || continue

            # Microcrate scoping: run from crate dir to ensure crate's own tests run
            crate_dir=""
            if [[ "$file" == crates/*/* ]]; then
              crate_dir="$(echo "$file" | cut -d/ -f1-2)"
            fi

            echo "::group::Mutants: $file"
            if [[ -n "$crate_dir" && -f "$crate_dir/Cargo.toml" ]]; then
              rel="${file#$crate_dir/}"
              (cd "$crate_dir" && cargo mutants --file "$rel" --timeout 120)
            else
              cargo mutants --file "$file" --timeout 120
            fi
            echo "::endgroup::"
          done < changed_files.txt

          echo "âœ“ All mutations caught or unviable (0 MISSED)"

      - name: Skip notice
        if: steps.changed.outputs.count == '0'
        run: echo "No production Rust files changed - skipping mutation testing"

      - name: Upload mutants report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: mutants-report
          path: mutants.out/
          if-no-files-found: ignore
          retention-days: 14
