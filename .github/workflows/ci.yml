name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build & Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Build
      run: cargo build --verbose
      
    - name: Run tests
      run: cargo test --verbose
      env:
        CI: true

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Lint
        run: cargo clippy -- -D warnings

  proptest-smoke:
    name: Proptest Smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run property tests (reduced iterations)
        run: |
          PROPTEST_CASES=50 cargo test -p tokmd-model --test properties --all-features --verbose
          PROPTEST_CASES=50 cargo test -p tokmd-types --test properties --all-features --verbose
          PROPTEST_CASES=50 cargo test -p tokmd --test properties --all-features --verbose
        env:
          CI: true

  publish-plan:
    name: Publish Plan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Verify publish plan
        run: cargo xtask publish --plan --verbose
        env:
          CI: true

  mutation:
    name: Mutation Testing (Required)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-mutants
        run: cargo install cargo-mutants --locked

      - name: Get changed Rust files
        id: changed
        run: |
          # Ensure base ref is available locally
          git fetch origin "${{ github.base_ref }}":"refs/remotes/origin/${{ github.base_ref }}" || true

          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- '*.rs' | grep -v '/tests/' | grep -v '_test\.rs$' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          COUNT=$(echo "$FILES" | grep -c . || echo 0)
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: Mutation Testing
        if: steps.changed.outputs.count != '0'
        env:
          CI: true
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
        run: |
          set -euo pipefail

          echo "Running mutation testing on ${{ steps.changed.outputs.count }} changed file(s)..."

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            [ -f "$file" ] || continue
            echo "::group::Testing mutations in: $file"
            cargo mutants --file "$file" --timeout 120
            echo "::endgroup::"
          done <<< "$CHANGED_FILES"

          echo "âœ“ All mutations caught or unviable (0 MISSED)"

      - name: Skip notice
        if: steps.changed.outputs.count == '0'
        run: echo "No production Rust files changed - skipping mutation testing"
