name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build & Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Build
      run: cargo build --verbose
      
    - name: Run tests
      run: cargo test --verbose
      env:
        CI: true

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Lint
        run: cargo clippy -- -D warnings

  proptest-smoke:
    name: Proptest Smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run property tests (reduced iterations)
        run: |
          PROPTEST_CASES=50 cargo test -p tokmd-model --test properties --all-features --verbose
          PROPTEST_CASES=50 cargo test -p tokmd-types --test properties --all-features --verbose
          PROPTEST_CASES=50 cargo test -p tokmd --test properties --all-features --verbose
        env:
          CI: true

  publish-plan:
    name: Publish Plan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Verify publish plan
        run: cargo xtask publish --plan --verbose
        env:
          CI: true

  mutation:
    name: Mutation Smoke Gate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-mutants
        run: cargo install cargo-mutants --version 26.1.2 --locked

      - name: Get changed Rust files (top 10 by churn)
        id: changed
        run: |
          set -euo pipefail
          git fetch origin "${{ github.base_ref }}":"refs/remotes/origin/${{ github.base_ref }}" || true

          git diff --numstat "origin/${{ github.base_ref }}...HEAD" -- '*.rs' \
            | awk '
                $3 !~ /\/tests\// &&
                $3 !~ /_test\.rs$/ &&
                $3 !~ /^fuzz\// &&
                $3 !~ /\/fuzz\// {
                  add=$1; del=$2;
                  if (add=="-") add=0;
                  if (del=="-") del=0;
                  print add+del "\t" $3
                }' \
            | sort -nr \
            | head -10 \
            | cut -f2 > changed_files.txt

          COUNT="$(wc -l < changed_files.txt | tr -d ' ')"
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          cat changed_files.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Mutation Testing (smoke gate)
        if: steps.changed.outputs.count != '0'
        env:
          CI: true
        run: |
          set -euo pipefail
          echo "Running mutation testing on ${{ steps.changed.outputs.count }} high-churn file(s)..."

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            [ -f "$file" ] || continue

            # Microcrate dividend: run from crate dir when possible
            crate_dir=""
            if [[ "$file" == crates/*/* ]]; then
              crate_dir="$(echo "$file" | cut -d/ -f1-2)"
            fi

            echo "::group::Mutants: $file"
            if [[ -n "$crate_dir" && -f "$crate_dir/Cargo.toml" ]]; then
              rel="${file#$crate_dir/}"
              (cd "$crate_dir" && cargo mutants --file "$rel" --timeout 300)
            else
              cargo mutants --file "$file" --timeout 300
            fi
            echo "::endgroup::"
          done < changed_files.txt

          echo "âœ“ All mutations caught or unviable (0 MISSED)"

      - name: Skip notice
        if: steps.changed.outputs.count == '0'
        run: echo "No production Rust files changed - skipping mutation testing"
