name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  msrv:
    name: MSRV Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Rust (MSRV)
        uses: dtolnay/rust-toolchain@1.100
      - name: Check MSRV compatibility
        run: cargo check --workspace --all-features

  build:
    name: Build & Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - uses: actions/checkout@v6

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Build
      run: cargo build --verbose

    - name: Run tests
      run: cargo test --verbose
      env:
        CI: true

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Lint
        run: cargo clippy -- -D warnings

  deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny@0.19.0
      - name: Print cargo-deny version
        run: cargo deny --version
      - name: Check advisories and licenses
        run: cargo deny --all-features check

  typos:
    name: Typos
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: crate-ci/typos@v1

  proptest-smoke:
    name: Proptest Smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - name: Run property tests (reduced iterations)
        run: |
          PROPTEST_CASES=50 cargo test -p tokmd-model --test properties --all-features --verbose
          PROPTEST_CASES=50 cargo test -p tokmd-types --test properties --all-features --verbose
          PROPTEST_CASES=50 cargo test -p tokmd --test properties --all-features --verbose
        env:
          CI: true

  publish-plan:
    name: Publish Plan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - name: Verify publish plan
        run: cargo xtask publish --plan --verbose
        env:
          CI: true

  docs-check:
    name: Docs Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - name: Check documentation drift
        run: cargo xtask docs --check
        env:
          CI: true

  nix:
    name: Nix Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Check flake
        run: nix flake check

      - name: Build package
        run: nix build

  mutation:
    name: Mutation Testing (Required)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-mutants
        run: cargo install cargo-mutants --version 26.1.2 --locked

      - name: Get changed Rust files
        id: changed
        run: |
          set -euo pipefail
          git fetch origin "${{ github.base_ref }}":"refs/remotes/origin/${{ github.base_ref }}" || true

          git diff --name-only "origin/${{ github.base_ref }}...HEAD" -- '*.rs' \
            | grep -v '/tests/' \
            | grep -v '_test\.rs$' \
            | grep -v '^fuzz/' \
            | grep -v '/fuzz/' \
            > changed_files.txt || true

          COUNT="$(wc -l < changed_files.txt | tr -d ' ')"
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          cat changed_files.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Mutation Testing
        if: steps.changed.outputs.count != '0'
        env:
          CI: true
        run: |
          set -euo pipefail
          echo "Running mutation testing on ${{ steps.changed.outputs.count }} changed file(s)..."

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            [ -f "$file" ] || continue

            # Microcrate dividend: run from crate dir when possible
            crate_dir=""
            if [[ "$file" == crates/*/* ]]; then
              crate_dir="$(echo "$file" | cut -d/ -f1-2)"
            fi

            echo "::group::Mutants: $file"
            if [[ -n "$crate_dir" && -f "$crate_dir/Cargo.toml" ]]; then
              rel="${file#$crate_dir/}"
              (cd "$crate_dir" && cargo mutants --file "$rel" --timeout 300)
            else
              cargo mutants --file "$file" --timeout 300
            fi
            echo "::endgroup::"
          done < changed_files.txt

          echo "âœ“ All mutations caught or unviable (0 MISSED)"

      - name: Skip notice
        if: steps.changed.outputs.count == '0'
        run: echo "No production Rust files changed - skipping mutation testing"

      - name: Upload mutants report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: mutants-report
          path: |
            mutants.out/
            crates/**/mutants.out/
          if-no-files-found: ignore
          retention-days: 14

  ci-required:
    name: CI (Required)
    runs-on: ubuntu-latest
    if: always()
    needs:
      - msrv
      - build
      - fmt
      - clippy
      - deny
      - typos
      - proptest-smoke
      - publish-plan
      - docs-check
      - nix
      - mutation
    steps:
      - name: Check overall status
        run: |
          # If any needed job failed or was cancelled, fail this job
          if [[ "${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more required jobs failed or were cancelled."
            exit 1
          fi
          echo "All required jobs passed (or were skipped)."
