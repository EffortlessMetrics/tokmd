# Run 2026-02-12.001

## Context
- Date: 2026-02-12
- Lane: Scout Discovery (Friction queue empty)
- Target: `tokmd init` DX improvement (config generation)

## Discovery
Found that `tokmd init` help text says "Write a .tokeignore template", but the interactive wizard also offers to write `tokmd.toml`.
There is no way to generate `tokmd.toml` non-interactively (e.g. for CI/scripts).
The `ProjectType` logic in `wizard.rs` duplicates some concepts from `InitProfile` in `tokmd-config`.

## Options
### Option A (Recommended): Add `--write-config` and refactor defaults
- Move project type defaults (roots, etc.) to `InitProfile` in `tokmd-config`.
- Add `--write-config` flag to `tokmd init`.
- Update `init` handler to write `tokmd.toml` using profile defaults if requested.
- Update help text.

### Option B: Documentation only
- Update help text to mention interactive config generation.
- Does not solve the automation gap.

## Decision
Choosing **Option A**. High value for automation/CI users, cleans up code duplication.

## Implementation Plan
1.  Move default logic from `wizard.rs` to `tokmd-config/src/lib.rs` (impl `InitProfile`).
2.  Add `write_config` boolean to `InitArgs`.
3.  Implement config generation in `tokmd/src/commands/init.rs` using `InitProfile`.
4.  Wire up the flag in `handle`.
5.  Verify with `cargo run -- init --help` and actual run.

## Receipts
(Will be appended)

## Verification Receipts
- `cargo build --verbose`: PASS
- `CI=true cargo test --verbose`: PASS (78 integration tests passed, including new test_init_write_config)
- `cargo fmt -- --check`: PASS (after auto-fix)
- `cargo clippy -- -D warnings`: PASS

## Changes
- Modified `crates/tokmd-config/src/lib.rs`: Added `write_config` to `InitArgs` and `default_toml` method to `InitProfile`.
- Modified `crates/tokmd/src/commands/init.rs`: Implemented config generation logic for non-interactive mode.
- Modified `crates/tokmd/src/interactive/wizard.rs`: Refactored to use `InitProfile` defaults.
- Added test in `crates/tokmd/tests/integration.rs`.

## CI Fixes
- **Fix 1:** Added  to  to prevent CI failure when running default tests without the  feature (which builds the  binary).
- **Fix 2:** Resolved strict Clippy lint  in  by using  instead of . This was flagged in the Nix build environment.

## Updated Verification
- `CI=true cargo test -p tokmd --test tok_integration`: PASS (0 tests, skipped as expected)
- `CI=true cargo test -p tokmd --test tok_integration --features alias-tok`: PASS (1 test, verifying feature works)
- `cargo clippy -p tokmd -- -D warnings`: PASS

## CI Fixes
- **Fix 1:** Added `#![cfg(feature = "alias-tok")]` to `crates/tokmd/tests/tok_integration.rs` to prevent CI failure when running default tests without the `alias-tok` feature (which builds the `tok` binary).
- **Fix 2:** Resolved strict Clippy lint `cloned_ref_to_slice_refs` in `crates/tokmd/src/export_bundle.rs` by using `std::slice::from_ref(&file_path)` instead of `&[file_path.clone()]`. This was flagged in the Nix build environment.

## Updated Verification
- `CI=true cargo test -p tokmd --test tok_integration`: PASS (0 tests, skipped as expected)
- `CI=true cargo test -p tokmd --test tok_integration --features alias-tok`: PASS (1 test, verifying feature works)
- `cargo clippy -p tokmd -- -D warnings`: PASS

## CI Fix 2
- **Fix 3:** Ran `cargo fmt` to resolve formatting errors introduced by the manual fix in `export_bundle.rs`.

## Updated Verification
- `cargo fmt -- --check`: PASS

## CI Fix 3
- **Fix 4:** Resolved Nix CI failure where tests could not access workspace-level `contracts/` directory.
- **Action:** Copied `contracts/sensor.report.v1/examples/*.json` to `crates/tokmd/tests/data/sensor_report/` and updated `tests/schema_validation.rs` to use the local path.

## Updated Verification
- `CI=true cargo test -p tokmd --test schema_validation`: PASS
